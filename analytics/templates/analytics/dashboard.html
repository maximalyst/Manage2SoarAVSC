{% extends "base.html" %}
{% load static %}
{% load json_script %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Operations Analytics</h2>
  </div>

  <form class="row g-2 mb-4">
    <div class="col-auto">
      <label class="form-label">Start</label>
      <input class="form-control" type="number" name="start" value="{{ start }}">
    </div>
    <div class="col-auto">
      <label class="form-label">End</label>
      <input class="form-control" type="number" name="end" value="{{ end }}">
    </div>
    <div class="col-auto form-check mt-4">
      <input class="form-check-input" type="checkbox" id="all" name="all" value="1" {% if not finalized %}checked{% endif %}>
      <label class="form-check-label" for="all">Include unfinalized</label>
    </div>
    <div class="col-auto mt-4">
      <button class="btn btn-primary">Update</button>
    </div>
  </form>

  {% if years|length == 0 %}
    <div class="alert alert-warning">
      <strong>No data</strong> for the selected range{% if finalized %} with “finalized only”{% endif %}.
      Try broadening the years or check “Include unfinalized”.
    </div>
  {% endif %}

{# ===== Annual charts ===== #}
<div class="card mb-4">
  <div class="card-body chart-card">
    <div class="btn-group btn-group-sm chart-tools" role="group"
         data-canvas="cumuChart" data-name="cumulative-flights">
      <button class="btn btn-outline-secondary chart-dl" data-type="png">PNG</button>
      <button class="btn btn-outline-secondary chart-dl" data-type="svg">SVG</button>
      <button class="btn btn-outline-secondary chart-dl" data-type="csv">CSV</button>
    </div>
    <h5 class="card-title mb-3 chart-title-pad">
      Cumulative Flights by Julian Day
      <span class="badge bg-secondary ms-2">Annual</span>
    </h5>
    <div class="chart-box"><canvas id="cumuChart"></canvas></div>
    <div class="small text-muted mt-2">
      Current year is emphasized. Hover any day to see the running total for that year.
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body chart-card">
    <div class="btn-group btn-group-sm chart-tools" role="group"
         data-canvas="byAcftChart" data-name="flights-by-year-by-aircraft">
      <button class="btn btn-outline-secondary chart-dl" data-type="png">PNG</button>
      <button class="btn btn-outline-secondary chart-dl" data-type="svg">SVG</button>
      <button class="btn btn-outline-secondary chart-dl" data-type="csv">CSV</button>
    </div>
    <h5 class="card-title mb-3 chart-title-pad">
      Flights by Year by Aircraft
      <span class="badge bg-secondary ms-2">Annual</span>
    </h5>
    <div class="chart-box"><canvas id="byAcftChart"></canvas></div>
    <div id="byAcftStatus" class="small text-muted mt-2">
      Club ships shown individually; non-club ships bucketed as <em>Private</em>. Flights with no identified glider
      appear as <em>Unknown</em>. Low-volume ships beyond the top N are grouped as <em>Other</em>.
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body chart-card">
    <div class="btn-group btn-group-sm chart-tools" role="group"
         data-canvas="timeOpsChart" data-name="time-of-day-operations">
      <button class="btn btn-outline-secondary chart-dl" data-type="png">PNG</button>
      <button class="btn btn-outline-secondary chart-dl" data-type="svg">SVG</button>
      <button class="btn btn-outline-secondary chart-dl" data-type="csv">CSV</button>
    </div>
    <h5 class="card-title mb-3 chart-title-pad">
      Time of Day Operations
      <span class="badge bg-secondary ms-2">Annual</span>
    </h5>
    <div class="chart-box"><canvas id="timeOpsChart"></canvas></div>
    <div id="timeOpsStatus" class="small text-muted mt-2">
      Blue dots: earliest takeoff times • Green dots: latest landing times • Lines show mean times by day
    </div>
  </div>
</div>

{# ===== Date-range section banner ===== #}
<div class="alert alert-info py-2 small">
  The charts below use the selected date range:
  <strong>{{ util_start|default:"(no start)" }}</strong> → <strong>{{ util_end|default:"(no end)" }}</strong>
  • {% if finalized %}showing <em>finalized only</em>{% else %}<em>including unfinalized</em>{% endif %}.
</div>

{# ===== Utilization (Date range) ===== #}
<div class="card mb-4">
  <div class="card-body chart-card">
    <div class="btn-group btn-group-sm chart-tools" role="group"
         data-canvas="utilChart" data-name="glider-utilization">
      <button class="btn btn-outline-secondary chart-dl" data-type="png">PNG</button>
      <button class="btn btn-outline-secondary chart-dl" data-type="svg">SVG</button>
      <button class="btn btn-outline-secondary chart-dl" data-type="csv">CSV</button>
    </div>

    <div class="d-flex justify-content-between align-items-end chart-title-pad">
      <h5 class="card-title mb-3">
        Glider Utilization
        <span class="badge bg-info text-dark ms-2">Date range</span>
      </h5>
      <form class="row g-2 align-items-end" method="get">
        <div class="col-auto">
          <label class="form-label small mb-1">From</label>
          <input class="form-control form-control-sm" type="date" name="util_start" value="{{ util_start }}">
        </div>
        <div class="col-auto">
          <label class="form-label small mb-1">To</label>
          <input class="form-control form-control-sm" type="date" name="util_end" value="{{ util_end }}">
        </div>
        <input type="hidden" name="start" value="{{ start }}">
        <input type="hidden" name="end" value="{{ end }}">
        {% if not finalized %}<input type="hidden" name="all" value="1">{% endif %}
        <div class="col-auto">
          <button class="btn btn-outline-primary btn-sm">Update</button>
        </div>
      </form>
    </div>

    <div class="chart-box chart-box--tall"><canvas id="utilChart"></canvas></div>
    <div id="utilStatus" class="small text-muted mt-2">
      Top 12 ships shown individually. Non-club ships bucketed as <em>Private</em>, null gliders as <em>Unknown</em>, remainder as <em>Other</em>.
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body chart-card">
    <div class="btn-group btn-group-sm chart-tools" role="group"
         data-canvas="utilPrivChart" data-name="private-glider-utilization">
      <button class="btn btn-outline-secondary chart-dl" data-type="png">PNG</button>
      <button class="btn btn-outline-secondary chart-dl" data-type="svg">SVG</button>
      <button class="btn btn-outline-secondary chart-dl" data-type="csv">CSV</button>
    </div>
    <h5 class="card-title mb-3 chart-title-pad">
      Private Glider Utilization (excludes club ships)
      <span class="badge bg-info text-dark ms-2">Date range</span>
    </h5>
    <div class="chart-box chart-box--tall"><canvas id="utilPrivChart"></canvas></div>
    <div id="utilPrivStatus" class="small text-muted mt-2">
      Each private ship listed individually. Date range matches the selector above.
    </div>
  </div>
</div>

{# ===== Member activity (Date range) ===== #}
<div class="row">
  <div class="col-lg-6">
    <div class="card mb-4">
      <div class="card-body chart-card">
        <div class="btn-group btn-group-sm chart-tools" role="group"
             data-canvas="fdChart" data-name="flying-days-by-member">
          <button class="btn btn-outline-secondary chart-dl" data-type="png">PNG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="svg">SVG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="csv">CSV</button>
        </div>
        <h5 class="card-title mb-3 chart-title-pad">
          Flying Days by Member
          <span class="badge bg-info text-dark ms-2">Date range</span>
        </h5>
        <div class="chart-box chart-box--xl"><canvas id="fdChart"></canvas></div>
        <div class="small text-muted mt-2" id="fdStatus"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card mb-4">
      <div class="card-body chart-card">
        <div class="btn-group btn-group-sm chart-tools" role="group"
             data-canvas="pgfChart" data-name="glider-flights-by-pilot">
          <button class="btn btn-outline-secondary chart-dl" data-type="png">PNG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="svg">SVG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="csv">CSV</button>
        </div>
        <h5 class="card-title mb-3 chart-title-pad">
          Glider Flights by Pilot (non-instruction)
          <span class="badge bg-info text-dark ms-2">Date range</span>
        </h5>
        <div class="chart-box chart-box--xl"><canvas id="pgfChart"></canvas></div>
        <div class="small text-muted mt-2" id="pgfStatus"></div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card mb-4">
      <div class="card-body chart-card">
        <div class="btn-group btn-group-sm chart-tools" role="group"
             data-canvas="durChart" data-name="flight-duration-distribution">
          <button class="btn btn-outline-secondary chart-dl" data-type="png">PNG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="svg">SVG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="csv">CSV</button>
        </div>
        <h5 class="card-title mb-3 chart-title-pad">
          Flight Duration Distribution
          <span class="badge bg-info text-dark ms-2">Date range</span>
        </h5>
        <div class="chart-box chart-box--short"><canvas id="durChart"></canvas></div>
        <div class="small text-muted mt-2" id="durStatus"></div>
      </div>
    </div>
  </div>
</div>

{# ===== Instructors & Tow-pilots (Date range) ===== #}
<div class="row">
  <div class="col-lg-6">
    <div class="card mb-4">
      <div class="card-body chart-card">
        <div class="btn-group btn-group-sm chart-tools" role="group"
             data-canvas="instChart" data-name="instructor-flights">
          <button class="btn btn-outline-secondary chart-dl" data-type="png">PNG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="svg">SVG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="csv">CSV</button>
        </div>
        <h5 class="card-title mb-3 chart-title-pad">
          Instructor Flights (by weekday)
          <span class="badge bg-info text-dark ms-2">Date range</span>
        </h5>
        <div class="chart-box chart-box--xl"><canvas id="instChart"></canvas></div>
        <div class="small text-muted mt-2" id="instStatus"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card mb-4">
      <div class="card-body chart-card">
        <div class="btn-group btn-group-sm chart-tools" role="group"
             data-canvas="towChart" data-name="tow-pilot-flights">
          <button class="btn btn-outline-secondary chart-dl" data-type="png">PNG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="svg">SVG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="csv">CSV</button>
        </div>
        <h5 class="card-title mb-3 chart-title-pad">
          Tow-pilot Flights (by weekday)
          <span class="badge bg-info text-dark ms-2">Date range</span>
        </h5>
        <div class="chart-box chart-box--xl"><canvas id="towChart"></canvas></div>
        <div class="small text-muted mt-2" id="towStatus"></div>
      </div>
    </div>
  </div>
</div>

{# ===== Long flights & Duty assignments (Date range) ===== #}
<div class="row">
  <div class="col-lg-6">
    <div class="card mb-4">
      <div class="card-body chart-card">
        <div class="btn-group btn-group-sm chart-tools" role="group"
             data-canvas="long3hChart" data-name="long-flights-3h">
          <button class="btn btn-outline-secondary chart-dl" data-type="png">PNG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="svg">SVG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="csv">CSV</button>
        </div>
        <h5 class="card-title mb-3 chart-title-pad">
          Long Flights (≥ 3 hours) by Pilot
          <span class="badge bg-info text-dark ms-2">Date range</span>
        </h5>
        <div class="chart-box chart-box--xl"><canvas id="long3hChart"></canvas></div>
        <div class="small text-muted mt-2" id="long3hStatus"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card mb-4">
      <div class="card-body chart-card">
        <div class="btn-group btn-group-sm chart-tools" role="group"
             data-canvas="dutyChart" data-name="do-ado-assignments">
          <button class="btn btn-outline-secondary chart-dl" data-type="png">PNG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="svg">SVG</button>
          <button class="btn btn-outline-secondary chart-dl" data-type="csv">CSV</button>
        </div>
        <h5 class="card-title mb-3 chart-title-pad">
          DO &amp; ADO Assignment Days
          <span class="badge bg-info text-dark ms-2">Date range</span>
        </h5>
        <div class="chart-box chart-box--xl"><canvas id="dutyChart"></canvas></div>
        <div class="small text-muted mt-2" id="dutyStatus"></div>
      </div>
    </div>
  </div>
</div>




<style>
  .chart-box { height: 440px; position: relative; }
  #cumuChart { width: 100% !important; height: 100% !important; display: block; }
</style>

{{ analytics_data|json_script:"analytics-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<script src="{% static 'analytics/charts.js' %}" defer></script>
<script defer>
  window.addEventListener("DOMContentLoaded", () => {
    const ALL = JSON.parse(document.getElementById("analytics-data").textContent || "{}");
    window.AnalyticsCharts?.initAll(ALL);
    // If charts.js exposes attachPngAuto, call it to bind all PNG buttons
    if (window.attachPngAuto) window.attachPngAuto();
  });
</script>
{% endblock %}
